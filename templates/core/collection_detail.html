{% extends 'base.html' %}

{% block title %}Eureka - {{ title }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Cabecera de la colección con diseño mejorado -->
    <div class="rounded-xl overflow-hidden mb-8 shadow-lg">
        <!-- Fondo con color aleatorio basado en el ID -->
        <div class="bg-gradient-to-r 
            {% if collection.pk|divisibleby:5 %}
                from-purple-500 to-indigo-600
            {% elif collection.pk|divisibleby:4 %}
                from-green-500 to-teal-600
            {% elif collection.pk|divisibleby:3 %}
                from-red-500 to-pink-600
            {% elif collection.pk|divisibleby:2 %}
                from-blue-500 to-indigo-600
            {% else %}
                from-eureka-orange to-yellow-500
            {% endif %} p-8">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-3xl font-bold text-white mb-2">{{ collection.name }}</h1>
                    <div class="flex items-center text-white text-opacity-90">
                        <div class="mr-4 flex items-center">
                            <i class="far fa-calendar-alt mr-1"></i> 
                            Creada el {{ collection.created_at|date:"d/m/Y" }}
                        </div>
                        <div class="flex items-center">
                            <i class="far fa-sticky-note mr-1"></i> 
                            {{ entries|length }} entradas
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <a href="{% url 'collection_edit' collection.pk %}" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full py-2 px-4 flex items-center transition-all duration-300">
                        <i class="fas fa-edit mr-2"></i> Editar
                    </a>
                    <a href="{% url 'collection_list' %}" class="bg-white text-gray-800 hover:bg-gray-100 rounded-full py-2 px-4 flex items-center transition-all duration-300 shadow-md">
                        <i class="fas fa-arrow-left mr-2"></i> Volver
                    </a>
                </div>
            </div>
            
            <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-filter backdrop-blur-sm text-white">
                {% if collection.description %}
                    {{ collection.description }}
                {% else %}
                    <span class="italic text-white text-opacity-70">Sin descripción</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Mensajes con animación -->
    {% if messages %}
        <div class="mb-8 space-y-2">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} animate-fadeIn">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Acciones rápidas -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-eureka-dark flex items-center">
            <i class="fas fa-list-alt text-eureka-orange mr-2"></i> Entradas en esta colección
        </h2>
        <div class="flex space-x-2">
            <a href="#nueva-entrada" class="btn-primary flex items-center transform transition hover:scale-105">
                <i class="fas fa-plus mr-2"></i> Nueva entrada
            </a>
            <a href="{% url 'collection_delete' collection.pk %}" class="text-red-500 hover:text-red-600 flex items-center px-3 py-1">
                <i class="fas fa-trash-alt mr-1"></i> Eliminar colección
            </a>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card p-0 mb-6 shadow-md border border-gray-100 overflow-hidden">
        <!-- Cabecera de filtros con gradiente mejorado -->
        <div class="bg-gradient-to-r from-eureka-orange to-yellow-500 p-4 flex items-center justify-between">
            <h3 class="text-md font-bold text-white flex items-center">
                <i class="fas fa-filter mr-2"></i> Filtrar entradas
            </h3>
            <button type="button" id="toggle-filters" class="text-sm text-white hover:text-gray-100 transition-colors bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full py-1 px-3 flex items-center">
                <i class="fas fa-chevron-down mr-1"></i> <span id="toggle-filters-text">Mostrar filtros</span>
            </button>
        </div>
        
        <form id="filter-form" method="get" class="space-y-4">
            <div id="filters-container" class="hidden p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Filtro de rango de fechas -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <label for="date_range" class="block text-sm font-medium text-eureka-dark mb-2 flex items-center">
                            <i class="fas fa-calendar-alt text-eureka-orange mr-2"></i> Rango de fechas
                        </label>
                        <select name="date_range" id="date_range" class="w-full rounded-md border-gray-300 shadow-sm focus:border-eureka-orange focus:ring focus:ring-eureka-orange focus:ring-opacity-50">
                            {% for option in date_range_options %}
                                <option value="{{ option.value }}" {% if date_range == option.value %}selected{% endif %}>{{ option.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filtro de colecciones -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <label for="collections" class="block text-sm font-medium text-eureka-dark mb-2 flex items-center">
                            <i class="fas fa-folder text-eureka-orange mr-2"></i> Colecciones
                        </label>
                        <select name="collections" id="collections" multiple class="w-full rounded-md border-gray-300 shadow-sm focus:border-eureka-orange focus:ring focus:ring-eureka-orange focus:ring-opacity-50" size="3">
                            <option value="all" {% if 'all' in selected_collections %}selected{% endif %}>Todas las colecciones</option>
                            {% for col in user_collections %}
                                <option value="{{ col.pk }}" {% if col.pk|stringformat:"s" in selected_collections %}selected{% endif %}>{{ col.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1 italic">Mantén presionado Ctrl para seleccionar múltiples</p>
                    </div>
                    
                    <!-- Switches para filtros adicionales -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow space-y-4">
                        <h4 class="text-sm font-medium text-eureka-dark flex items-center mb-2">
                            <i class="fas fa-sliders-h text-eureka-orange mr-2"></i> Opciones adicionales
                        </h4>
                        
                        <!-- Switch para favoritos -->
                        <div class="flex items-center justify-between">
                            <label for="only_favorites" class="text-sm text-gray-700 flex items-center">
                                <i class="fas fa-star text-yellow-500 mr-2"></i> Solo favoritos
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="only_favorites" id="only_favorites" class="sr-only peer" {% if only_favorites %}checked{% endif %}>
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange"></div>
                            </label>
                        </div>
                        
                        <!-- Switch para borradores -->
                        <div class="flex items-center justify-between">
                            <label for="include_drafts" class="text-sm text-gray-700 flex items-center">
                                <i class="fas fa-file-alt text-blue-500 mr-2"></i> Solo borradores
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="include_drafts" id="include_drafts" class="sr-only peer" {% if include_drafts %}checked{% endif %}>
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6 space-x-3">
                    <button type="button" id="reset-filters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center">
                        <i class="fas fa-undo mr-2"></i> Restablecer
                    </button>
                    <button type="submit" class="px-4 py-2 bg-eureka-orange text-white rounded-md hover:bg-eureka-dark transition-colors flex items-center shadow-sm">
                        <i class="fas fa-search mr-2"></i> Aplicar filtros
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Nueva entrada con diseño mejorado -->
    <div id="nueva-entrada" class="card p-6 mb-8 shadow-md border border-gray-100 transform transition-all duration-300 hover:shadow-lg">
        <h3 class="text-lg font-bold text-eureka-dark mb-4 flex items-center">
            <i class="fas fa-feather-alt text-eureka-orange mr-2"></i> Crear nueva entrada
        </h3>
        <form method="post" action="{% url 'entry_create' collection.pk %}" class="space-y-4" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="flex items-start space-x-4">
                <div class="w-10 h-10 rounded-full overflow-hidden">
                    {% if user.profile.profile_thumbnail %}
                        <img src="{{ user.profile.profile_thumbnail.url }}?t={{ user.profile.updated_at|date:'U' }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark font-bold">
                            {{ user.username.0|upper }}
                        </div>
                    {% endif %}
                </div>
                <div class="flex-grow">
                    <input type="text" name="title" class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-eureka-orange focus:border-transparent transition-all mb-3" placeholder="Título de la entrada">
                    <textarea name="content" class="w-full p-4 rounded-lg bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-eureka-orange focus:border-transparent transition-all" rows="3" placeholder="¿Qué estás pensando?"></textarea>
                    
                    <!-- Campo para subir imagen -->
                    <div class="mt-3 mb-3">
                        <label class="flex items-center p-3 rounded-lg border border-dashed border-gray-300 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors">
                            <input type="file" name="entry_image" id="entry_image" class="hidden" accept="image/*" onchange="previewImage(this)">
                            <div class="mr-3 text-gray-500">
                                <i class="fas fa-image text-xl"></i>
                            </div>
                            <div class="flex-grow">
                                <span class="text-sm text-gray-700">Añadir imagen (opcional)</span>
                                <p class="text-xs text-gray-500">JPG, PNG o GIF (máx. 5MB)</p>
                            </div>
                            <div id="image-preview-container" class="hidden ml-auto">
                                <img id="image-preview" class="h-10 w-10 object-cover rounded" src="#" alt="Vista previa">
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-3 space-y-3 sm:space-y-0">
                        <div class="flex flex-wrap gap-2">
                            <!-- Switch para visibilidad -->
                            <div class="flex items-center">
                                <label class="inline-flex items-center cursor-pointer">
                                    <span class="me-2 text-sm">
                                        <i class="fas fa-eye-slash text-gray-500"></i>
                                    </span>
                                    <input type="checkbox" name="visibility_switch" id="visibility_switch" class="sr-only peer" onchange="updateVisibilityValue()">
                                    <input type="hidden" name="visibility" id="visibility_input" value="private">
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange">
                                    </div>
                                    <span class="ms-2 text-sm">
                                        <i class="fas fa-globe text-gray-500"></i>
                                    </span>
                                </label>
                            </div>
                            
                            <!-- Botones para estado -->
                            <div class="flex flex-wrap gap-1">
                                <input type="hidden" name="status" id="status_input" value="saved">
                                <button type="button" id="btn_draft" onclick="setStatus('draft')" class="px-2 py-1 rounded-md bg-gray-100 text-gray-700 border border-gray-200 flex items-center text-sm">
                                    <i class="fas fa-file-alt mr-1"></i> Borrador
                                </button>
                                <button type="button" id="btn_saved" onclick="setStatus('saved')" class="px-2 py-1 rounded-md bg-green-100 text-green-700 border-green-200 status-active flex items-center text-sm">
                                    <i class="fas fa-save mr-1"></i> Guardado
                                </button>
                                <button type="button" id="btn_favorite" onclick="setStatus('favorite')" class="px-2 py-1 rounded-md bg-gray-100 text-gray-700 border border-gray-200 flex items-center text-sm">
                                    <i class="fas fa-star mr-1"></i> Favorito
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary transform transition hover:scale-105 whitespace-nowrap">
                            <i class="fas fa-feather-alt mr-2"></i> Publicar
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Entradas de la colección con diseño mejorado -->
    <div class="space-y-6">
        {% if entries %}
            {% for entry in entries %}
                <div class="card shadow-md border border-gray-100 overflow-hidden transform transition-all duration-300 hover:shadow-lg">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                                {% if entry.user.profile.profile_thumbnail %}
                                    <img src="{{ entry.user.profile.profile_thumbnail.url }}?t={{ entry.user.profile.updated_at|date:'U' }}" alt="{{ entry.user.username }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark font-bold">
                                        {{ entry.user.username.0|upper }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h3 class="font-bold text-eureka-dark">{{ entry.user.username }}</h3>
                                <p class="text-gray-500 text-xs">{{ entry.created_at|date:"d/m/Y H:i" }}</p>
                            </div>
                            <div class="ml-auto">
                                <div class="relative dropdown-menu">
                                    <button class="text-gray-400 hover:text-eureka-orange transition-colors p-2 rounded-full hover:bg-gray-100 dropdown-toggle">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="fixed mt-1 w-48 bg-white rounded-md shadow-lg overflow-visible z-[100] hidden dropdown-content border border-gray-200">
                                        <div class="py-1">
                                            <a href="{% url 'entry_detail' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <i class="fas fa-eye mr-2 text-blue-500"></i> Ver detalle
                                            </a>
                                            <a href="{% url 'entry_edit' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <i class="fas fa-edit mr-2 text-green-500"></i> Editar
                                            </a>
                                            <a href="{% url 'entry_toggle_visibility' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                {% if entry.visibility == 'public' %}
                                                    <i class="fas fa-eye-slash mr-2 text-blue-500"></i> Hacer privada
                                                {% else %}
                                                    <i class="fas fa-eye mr-2 text-green-500"></i> Hacer pública
                                                {% endif %}
                                            </a>
                                            <div class="border-t border-gray-100 my-1"></div>
                                            <a href="{% url 'entry_delete' entry.pk %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                                <i class="fas fa-trash-alt mr-2"></i> Eliminar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="{% url 'entry_detail' entry.pk %}" class="block">
                            <h4 class="text-xl font-bold text-eureka-dark mb-2 hover:text-eureka-orange transition-colors">{{ entry.title }}</h4>
                            <p class="text-gray-700 mb-4">{{ entry.content|truncatewords:30 }}</p>
                            
                            {% if entry.entry_image %}
                            <div class="relative h-48 mb-4 rounded-lg overflow-hidden">
                                <a href="{{ entry.entry_image.url }}?t={{ entry.updated_at|date:'U' }}" 
                                   class="entry-image-link cursor-zoom-in block"
                                   data-pswp-width="{{ entry.entry_image.width }}" 
                                   data-pswp-height="{{ entry.entry_image.height }}"
                                   target="_blank">
                                    <img src="{{ entry.entry_image.url }}?t={{ entry.updated_at|date:'U' }}" 
                                         alt="{{ entry.title }}" 
                                         class="w-full h-full object-cover hover:opacity-95 transition-opacity">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all flex items-center justify-center">
                                        <div class="text-white opacity-0 hover:opacity-100 transition-opacity">
                                            <i class="fas fa-search-plus text-xl"></i>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endif %}
                        </a>
                        <div class="flex justify-between items-center">
                            <div class="flex space-x-4">
                                <a href="{% url 'entry_toggle_favorite' entry.pk %}" class="flex items-center text-gray-500 hover:text-eureka-orange transition-colors">
                                    {% if entry.status == 'favorite' %}
                                        <i class="fas fa-star text-yellow-500 mr-1"></i>
                                        <span>Favorito</span>
                                    {% else %}
                                        <i class="far fa-star mr-1"></i>
                                        <span>Marcar favorito</span>
                                    {% endif %}
                                </a>
                            </div>
                            <a href="{% url 'entry_detail' entry.pk %}" class="text-eureka-orange hover:underline flex items-center">
                                Leer más <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </a>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                        <span class="text-sm text-gray-500 flex items-center">
                            <i class="fas fa-folder text-eureka-orange mr-1"></i>
                            {{ entry.collection.name }}
                        </span>
                        <span class="text-sm text-gray-500 flex items-center">
                            <i class="fas fa-eye text-eureka-orange mr-1"></i>
                            {{ entry.get_visibility_display }}
                        </span>
                    </div>
                </div>
            {% endfor %}
            
            <!-- Paginación -->
            {% if entries.paginator.num_pages > 1 %}
            <div class="flex justify-center mt-8">
                <nav class="inline-flex rounded-lg shadow-md overflow-hidden" aria-label="Paginación">
                    <!-- Botón anterior -->
                    {% if entries.has_previous %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ entries.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-white text-sm font-medium text-eureka-dark hover:bg-gray-50 transition-colors">
                            <i class="fas fa-chevron-left text-xs mr-1"></i>
                            <span>Anterior</span>
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                            <i class="fas fa-chevron-left text-xs mr-1"></i>
                            <span>Anterior</span>
                        </span>
                    {% endif %}
                    
                    <!-- Números de página -->
                    <div class="hidden md:flex">
                        {% for i in entries.paginator.page_range %}
                            {% if entries.number == i %}
                                <span class="relative inline-flex items-center px-4 py-2 border-t border-b border-gray-200 bg-eureka-orange text-sm font-medium text-white">
                                    {{ i }}
                                </span>
                            {% elif i > entries.number|add:'-3' and i < entries.number|add:'3' %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ i }}" class="relative inline-flex items-center px-4 py-2 border-t border-b border-gray-200 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    {{ i }}
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Indicador de página en móvil -->
                    <div class="flex md:hidden items-center px-4 py-2 border-t border-b border-gray-200 bg-white text-sm font-medium text-gray-700">
                        <span>{{ entries.number }} de {{ entries.paginator.num_pages }}</span>
                    </div>
                    
                    <!-- Botón siguiente -->
                    {% if entries.has_next %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ entries.next_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-white text-sm font-medium text-eureka-dark hover:bg-gray-50 transition-colors">
                            <span>Siguiente</span>
                            <i class="fas fa-chevron-right text-xs ml-1"></i>
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                            <span>Siguiente</span>
                            <i class="fas fa-chevron-right text-xs ml-1"></i>
                        </span>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        {% else %}
            <div class="card p-12 text-center bg-gradient-to-b from-white to-gray-50 shadow-md border border-gray-100">
                <div class="text-8xl text-eureka-orange mb-6 animate-pulse">
                    <i class="fas fa-feather-alt"></i>
                </div>
                <h3 class="text-2xl font-bold text-eureka-dark mb-3">¡Esta colección está vacía!</h3>
                <p class="text-gray-600 mb-8 max-w-md mx-auto">Aún no hay entradas en esta colección. Crea tu primera entrada para comenzar a compartir tus ideas.</p>
                <a href="#nueva-entrada" class="btn-primary inline-block transform transition hover:scale-105 shadow-lg">
                    <i class="fas fa-plus mr-2"></i> Crear mi primera entrada
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- Sugerencias -->
    {% if entries %}
    <div class="mt-8 bg-blue-50 rounded-lg p-4 border border-blue-100">
        <h3 class="text-blue-800 font-medium flex items-center mb-2">
            <i class="fas fa-lightbulb text-blue-500 mr-2"></i> Consejos para gestionar tu colección
        </h3>
        <ul class="text-blue-700 text-sm space-y-2">
            <li class="flex items-start">
                <i class="fas fa-check-circle text-blue-500 mr-2 mt-1"></i>
                <span>Mantén tus entradas organizadas por temas para facilitar su búsqueda</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-blue-500 mr-2 mt-1"></i>
                <span>Actualiza regularmente el contenido para mantener la colección relevante</span>
            </li>
        </ul>
    </div>
    {% endif %}
</div>

<!-- Contenedor de PhotoSwipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Cerrar (Esc)"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Anterior"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Siguiente"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar PhotoSwipe
        initPhotoSwipe();
        
        // Manejo de los filtros
        const toggleFiltersBtn = document.getElementById('toggle-filters');
        const toggleFiltersText = document.getElementById('toggle-filters-text');
        const filtersContainer = document.getElementById('filters-container');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        // Mostrar/ocultar filtros
        if (toggleFiltersBtn && filtersContainer) {
            toggleFiltersBtn.addEventListener('click', function() {
                const isHidden = filtersContainer.classList.contains('hidden');
                filtersContainer.classList.toggle('hidden');
                
                // Cambiar el texto del botón
                if (isHidden) {
                    toggleFiltersText.textContent = 'Ocultar filtros';
                    toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-down');
                    toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-up');
                } else {
                    toggleFiltersText.textContent = 'Mostrar filtros';
                    toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-up');
                    toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-down');
                }
                
                // Animación suave
                if (isHidden) {
                    filtersContainer.style.maxHeight = '0';
                    filtersContainer.style.opacity = '0';
                    setTimeout(() => {
                        filtersContainer.style.transition = 'max-height 0.3s ease-in-out, opacity 0.3s ease-in-out';
                        filtersContainer.style.maxHeight = '1000px';
                        filtersContainer.style.opacity = '1';
                    }, 10);
                }
            });
        }
        
        // Restablecer filtros
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                // Restablecer selects
                document.getElementById('date_range').value = '7';
                
                // Restablecer select múltiple de colecciones
                const collectionsSelect = document.getElementById('collections');
                if (collectionsSelect) {
                    for (let i = 0; i < collectionsSelect.options.length; i++) {
                        collectionsSelect.options[i].selected = (i === 0); // Seleccionar solo "Todas las colecciones"
                    }
                }
                
                // Restablecer switches
                const switches = ['only_favorites', 'include_drafts'];
                switches.forEach(switchId => {
                    const switchElement = document.getElementById(switchId);
                    if (switchElement) switchElement.checked = false;
                });
                
                // Enviar el formulario
                document.getElementById('filter-form').submit();
            });
        }
        
        // Mostrar filtros si hay alguno activo
        const hasActiveFilters = {{ only_favorites|yesno:"true,false" }} || 
                               {{ include_drafts|yesno:"true,false" }} || 
                               "{{ date_range }}" !== "7" ||
                               !("{{ selected_collections }}" === "['all']" || "{{ selected_collections }}" === "['{{ collection.pk }}']");
        
        if (hasActiveFilters && filtersContainer) {
            filtersContainer.classList.remove('hidden');
            if (toggleFiltersText) toggleFiltersText.textContent = 'Ocultar filtros';
            if (toggleFiltersBtn) {
                toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-down');
                toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-up');
            }
        }
    });
    
    // Función para previsualizar la imagen seleccionada
    function previewImage(input) {
        const preview = document.getElementById('image-preview');
        const previewContainer = document.getElementById('image-preview-container');
        const removeBtn = document.getElementById('remove-image');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                previewContainer.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // Función para eliminar la imagen seleccionada
    function removeImage() {
        const input = document.getElementById('entry_image');
        const preview = document.getElementById('image-preview');
        const previewContainer = document.getElementById('image-preview-container');
        const removeBtn = document.getElementById('remove-image');
        
        input.value = '';
        preview.src = '';
        previewContainer.classList.add('hidden');
        removeBtn.classList.add('hidden');
    }
    
    // Función para inicializar PhotoSwipe
    function initPhotoSwipe() {
        const entryImageLinks = document.querySelectorAll('.entry-image-link');
        
        if (entryImageLinks.length > 0) {
            const lightbox = new PhotoSwipeLightbox({
                gallery: '.card',
                children: 'a.entry-image-link',
                pswpModule: PhotoSwipe,
                showHideAnimationType: 'zoom',
                initialZoomLevel: 'fit',
                secondaryZoomLevel: 2,
                maxZoomLevel: 4,
                wheelToZoom: true,
                padding: { top: 30, bottom: 30, left: 30, right: 30 },
                bgOpacity: 0.85,
                mainClass: 'pswp--custom-bg',
                closeTitle: 'Cerrar (Esc)',
                zoomTitle: 'Zoom in/out',
                arrowPrevTitle: 'Anterior',
                arrowNextTitle: 'Siguiente',
                errorMsg: 'La imagen no se pudo cargar'
            });
            
            lightbox.on('uiRegister', function() {
                lightbox.pswp.ui.registerElement({
                    name: 'custom-caption',
                    order: 9,
                    isButton: false,
                    appendTo: 'root',
                    html: 'Caption text',
                    onInit: (el, pswp) => {
                        lightbox.pswp.on('change', () => {
                            const currSlideElement = lightbox.pswp.currSlide.data.element;
                            let captionHTML = '';
                            if (currSlideElement) {
                                const alt = currSlideElement.querySelector('img').getAttribute('alt');
                                captionHTML = alt || '';
                            }
                            el.innerHTML = captionHTML;
                        });
                    }
                });
            });
            
            lightbox.init();
            
            // Prevenir comportamiento predeterminado de los enlaces
            entryImageLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                });
            });
        }
    }
    
    // Función para actualizar el valor de visibilidad basado en el switch
    function updateVisibilityValue() {
        const switchElement = document.getElementById('visibility_switch');
        const inputElement = document.getElementById('visibility_input');
        
        if (switchElement.checked) {
            inputElement.value = 'public';
        } else {
            inputElement.value = 'private';
        }
    }
    
    // Función para establecer el estado de la entrada
    function setStatus(status) {
        document.getElementById('status_input').value = status;
        
        // Actualizar estilos de los botones
        const buttons = {
            'draft': document.getElementById('btn_draft'),
            'saved': document.getElementById('btn_saved'),
            'favorite': document.getElementById('btn_favorite')
        };
        
        for (const [key, button] of Object.entries(buttons)) {
            if (button) {
                if (key === status) {
                    button.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
                    button.classList.add('status-active', key === 'draft' ? 'bg-blue-100 text-blue-700 border-blue-200' : 
                                         key === 'saved' ? 'bg-green-100 text-green-700 border-green-200' : 
                                         'bg-yellow-100 text-yellow-700 border-yellow-200');
                } else {
                    button.classList.remove('status-active', 'bg-blue-100', 'text-blue-700', 'border-blue-200',
                                          'bg-green-100', 'text-green-700', 'border-green-200',
                                          'bg-yellow-100', 'text-yellow-700', 'border-yellow-200');
                    button.classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
                }
            }
        }
    }
</script>
{% endblock %} 