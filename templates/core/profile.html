{% extends 'base.html' %}

{% block title %}Eureka - Perfil{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Cabecera del perfil -->
    <div class="card overflow-hidden mb-6">
        <!-- Portada -->
        <div class="h-48 bg-gradient-to-r from-eureka-orange to-yellow-400 relative overflow-hidden">
            {% if user.profile.banner_image %}
                <img src="{{ user.profile.banner_image.url }}" alt="Portada de {{ user.username }}" class="w-full h-full object-cover">
            {% endif %}
            <!-- Botón de editar perfil -->
            <a href="{% url 'edit_profile' %}" class="absolute top-4 right-4 bg-white bg-opacity-90 text-eureka-dark rounded-full py-1 px-4 flex items-center hover:bg-opacity-100 transition-all shadow-md">
                <i class="fas fa-edit mr-2"></i> Editar perfil
            </a>
        </div>
        
        <!-- Información del perfil -->
        <div class="px-6 py-4 relative">
            <!-- Avatar -->
            <div class="w-24 h-24 rounded-full absolute -top-12 left-6 border-4 border-white shadow-md overflow-hidden">
                {% if user.profile.profile_image %}
                    <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                {% else %}
                    <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark text-4xl font-bold">
                        {{ user.username.0|upper }}
                    </div>
                {% endif %}
            </div>
            
            <div class="ml-32">
                <h1 class="text-2xl font-bold text-eureka-dark">{{ user.get_full_name|default:user.username }}</h1>
                <p class="text-gray-500">@{{ user.username }}</p>
                
                <div class="flex items-center mt-2 text-gray-600">
                    <div class="flex items-center mr-4">
                        <i class="far fa-calendar-alt text-eureka-orange mr-1"></i>
                        <span>Se unió el {{ user.date_joined|date:"d/m/Y" }}</span>
                    </div>
                </div>
                
                <!-- Cambiamos de flex a grid para mejor responsive -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4">
                    <div class="flex items-center">
                        <span class="font-bold text-eureka-dark mr-1">{{ user.collections.count }}</span>
                        <span class="text-gray-600">Colecciones</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-eureka-dark mr-1">{{ user.entries.count }}</span>
                        <span class="text-gray-600">Entradas</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-eureka-dark mr-1">{{ user.friendships.count }}</span>
                        <span class="text-gray-600">Siguiendo</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-eureka-dark mr-1">{{ user.friends.count }}</span>
                        <span class="text-gray-600">Seguidores</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenido principal -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Columna izquierda - Información adicional -->
        <div class="md:col-span-1">
            <!-- Sobre mí -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-bold text-eureka-dark mb-4 flex items-center">
                    <i class="fas fa-user text-eureka-orange mr-2"></i> Sobre mí
                </h2>
                <p class="text-gray-600 mb-4">
                    {% if user.profile.bio %}
                        {{ user.profile.bio }}
                    {% else %}
                        No hay información disponible.
                    {% endif %}
                </p>
                <a href="{% url 'edit_profile' %}" class="text-eureka-orange hover:underline text-sm">Editar información</a>
            </div>
            
            <!-- Mis colecciones -->
            <div class="card overflow-hidden mb-6">
                <div class="bg-eureka-dark text-white py-3 px-4 flex justify-between items-center">
                    <h3 class="font-bold text-eureka-orange">Mis Colecciones</h3>
                    <a href="{% url 'collection_create' %}" class="text-white hover:text-eureka-orange transition-colors">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
                
                {% if user.collections.exists %}
                    <div class="divide-y divide-gray-100">
                        {% for collection in user.collections.all|slice:":5" %}
                            <a href="{% url 'collection_detail' collection.pk %}" class="block p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-bold text-eureka-dark">{{ collection.name }}</h4>
                                        <p class="text-sm text-gray-500">{{ collection.entries.count }} entradas</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-eureka-orange"></i>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                    <div class="bg-gray-50 p-3 text-center">
                        <a href="{% url 'collection_list' %}" class="text-eureka-orange hover:underline">Ver todas las colecciones</a>
                    </div>
                {% else %}
                    <div class="p-6 text-center">
                        <div class="text-4xl text-eureka-orange mb-2">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <p class="text-gray-600 mb-4">No tienes colecciones aún.</p>
                        <a href="{% url 'collection_create' %}" class="btn-primary inline-flex items-center">
                            <i class="fas fa-plus mr-2"></i> Crear colección
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Amigos -->
            <div class="card overflow-hidden">
                <div class="bg-eureka-dark text-white py-3 px-4 flex justify-between items-center">
                    <h3 class="font-bold text-eureka-orange">Amigos</h3>
                    <a href="#" class="text-white hover:text-eureka-orange transition-colors">
                        <i class="fas fa-user-plus"></i>
                    </a>
                </div>
                
                <div class="p-4">
                    <div class="flex flex-wrap gap-2">
                        {% for friendship in user.friendships.all|slice:":8" %}
                            <div class="w-12 h-12 rounded-full overflow-hidden" title="{{ friendship.friend.username }}">
                                {% if friendship.friend.profile.profile_thumbnail %}
                                    <img src="{{ friendship.friend.profile.profile_thumbnail.url }}" alt="{{ friendship.friend.username }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark font-bold">
                                        {{ friendship.friend.username.0|upper }}
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <p class="text-gray-600 py-2">No has agregado amigos aún.</p>
                        {% endfor %}
                    </div>
                </div>
                
                {% if user.friendships.exists %}
                    <div class="bg-gray-50 p-3 text-center">
                        <a href="#" class="text-eureka-orange hover:underline">Ver todos los amigos</a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Columna derecha - Entradas -->
        <div class="md:col-span-2">
            <!-- Pestañas -->
            <div class="bg-white rounded-t-xl shadow-sm border-b border-gray-200 mb-6">
                <div class="flex">
                    <a href="{% url 'profile' %}?tab=entries" class="flex-1 py-4 px-6 text-center {% if tab == 'entries' %}border-b-2 border-eureka-orange font-medium text-eureka-orange{% else %}text-gray-500 hover:text-eureka-orange transition-colors{% endif %}">
                        Entradas
                    </a>
                    <a href="{% url 'profile' %}?tab=favorites" class="flex-1 py-4 px-6 text-center {% if tab == 'favorites' %}border-b-2 border-eureka-orange font-medium text-eureka-orange{% else %}text-gray-500 hover:text-eureka-orange transition-colors{% endif %}">
                        Favoritos
                    </a>
                    <a href="{% url 'profile' %}?tab=drafts" class="flex-1 py-4 px-6 text-center {% if tab == 'drafts' %}border-b-2 border-eureka-orange font-medium text-eureka-orange{% else %}text-gray-500 hover:text-eureka-orange transition-colors{% endif %}">
                        Borradores
                    </a>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="card p-0 mb-6 shadow-md border border-gray-100 overflow-hidden">
                <!-- Cabecera de filtros con gradiente mejorado -->
                <div class="bg-gradient-to-r from-eureka-orange to-yellow-500 p-4 flex items-center justify-between">
                    <h3 class="text-md font-bold text-white flex items-center">
                        <i class="fas fa-filter mr-2"></i> Filtrar entradas
                    </h3>
                    <button type="button" id="toggle-filters" class="text-sm text-white hover:text-gray-100 transition-colors bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full py-1 px-3 flex items-center">
                        <i class="fas fa-chevron-down mr-1"></i> <span id="toggle-filters-text">Mostrar filtros</span>
                    </button>
                </div>
                
                <form id="filter-form" method="get" class="space-y-4">
                    <!-- Mantener el tab actual al enviar el formulario -->
                    <input type="hidden" name="tab" value="{{ tab }}">
                    
                    <div id="filters-container" class="hidden p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Filtro de rango de fechas -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                <label for="date_range" class="block text-sm font-medium text-eureka-dark mb-2 flex items-center">
                                    <i class="fas fa-calendar-alt text-eureka-orange mr-2"></i> Rango de fechas
                                </label>
                                <select name="date_range" id="date_range" class="w-full rounded-md border-gray-300 shadow-sm focus:border-eureka-orange focus:ring focus:ring-eureka-orange focus:ring-opacity-50">
                                    {% for option in date_range_options %}
                                        <option value="{{ option.value }}" {% if date_range == option.value %}selected{% endif %}>{{ option.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Filtro de colecciones -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                <label for="collections" class="block text-sm font-medium text-eureka-dark mb-2 flex items-center">
                                    <i class="fas fa-folder text-eureka-orange mr-2"></i> Colecciones
                                </label>
                                <select name="collections" id="collections" multiple class="w-full rounded-md border-gray-300 shadow-sm focus:border-eureka-orange focus:ring focus:ring-eureka-orange focus:ring-opacity-50" size="3">
                                    <option value="all" {% if 'all' in selected_collections %}selected{% endif %}>Todas las colecciones</option>
                                    {% for col in user_collections %}
                                        <option value="{{ col.pk }}" {% if col.pk|stringformat:"s" in selected_collections %}selected{% endif %}>{{ col.name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1 italic">Mantén presionado Ctrl para seleccionar múltiples</p>
                            </div>
                            
                            <!-- Switches para filtros adicionales -->
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow space-y-4">
                                <h4 class="text-sm font-medium text-eureka-dark flex items-center mb-2">
                                    <i class="fas fa-sliders-h text-eureka-orange mr-2"></i> Opciones adicionales
                                </h4>
                                
                                <!-- Switch para favoritos -->
                                <div class="flex items-center justify-between">
                                    <label for="only_favorites" class="text-sm text-gray-700 flex items-center">
                                        <i class="fas fa-star text-yellow-500 mr-2"></i> Solo favoritos
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="only_favorites" id="only_favorites" class="sr-only peer" {% if only_favorites %}checked{% endif %}>
                                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange"></div>
                                    </label>
                                </div>
                                
                                <!-- Switch para borradores -->
                                <div class="flex items-center justify-between">
                                    <label for="include_drafts" class="text-sm text-gray-700 flex items-center">
                                        <i class="fas fa-file-alt text-blue-500 mr-2"></i> Solo borradores
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="include_drafts" id="include_drafts" class="sr-only peer" {% if include_drafts %}checked{% endif %}>
                                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-6 space-x-3">
                            <button type="button" id="reset-filters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center">
                                <i class="fas fa-undo mr-2"></i> Restablecer
                            </button>
                            <button type="submit" class="px-4 py-2 bg-eureka-orange text-white rounded-md hover:bg-eureka-dark transition-colors flex items-center shadow-sm">
                                <i class="fas fa-search mr-2"></i> Aplicar filtros
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Nueva entrada -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-eureka-dark mb-4 flex items-center">
                    <i class="fas fa-feather-alt text-eureka-orange mr-2"></i> Crear nueva entrada
                </h3>
                <form method="post" action="{% url 'profile_entry_create' %}" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    
                    <!-- Mensajes de error del formulario -->
                    {% if form_errors %}
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-500"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Por favor corrige los siguientes errores:</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        {% for field, errors in form_errors.items %}
                                            {% for error in errors %}
                                            <li>{{ field|title }}: {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 rounded-full overflow-hidden">
                            {% if user.profile.profile_thumbnail %}
                                <img src="{{ user.profile.profile_thumbnail.url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark font-bold">
                                    {{ user.username.0|upper }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-grow">
                            <!-- Título de la entrada -->
                            <input type="text" name="title" placeholder="Título de la entrada" class="w-full p-3 rounded-lg bg-gray-50 border {% if form_errors.title %}border-red-500{% else %}border-gray-200{% endif %} focus:outline-none focus:ring-2 focus:ring-eureka-orange focus:border-transparent transition-all mb-3" required value="{{ form.title.value|default:'' }}">
                            {% if form_errors.title %}
                            <p class="text-red-500 text-xs italic">{{ form_errors.title.0 }}</p>
                            {% endif %}
                            
                            <!-- Contenido de la entrada -->
                            <textarea name="content" rows="3" placeholder="¿Qué estás pensando?" class="w-full p-4 rounded-lg bg-gray-50 border {% if form_errors.content %}border-red-500{% else %}border-gray-200{% endif %} focus:outline-none focus:ring-2 focus:ring-eureka-orange focus:border-transparent transition-all" required>{{ form.content.value|default:'' }}</textarea>
                            {% if form_errors.content %}
                            <p class="text-red-500 text-xs italic">{{ form_errors.content.0 }}</p>
                            {% endif %}
                            
                            <!-- Campo para subir imagen -->
                            <div class="mt-3 mb-3">
                                <label class="flex items-center p-3 rounded-lg border border-dashed border-gray-300 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors">
                                    <input type="file" name="entry_image" id="entry_image" class="hidden" accept="image/*" onchange="previewImage(this)">
                                    <div class="mr-3 text-gray-500">
                                        <i class="fas fa-image text-xl"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <span class="text-sm text-gray-700">Añadir imagen (opcional)</span>
                                        <p class="text-xs text-gray-500">JPG, PNG o GIF (máx. 5MB)</p>
                                    </div>
                                    <div id="image-preview-container" class="hidden ml-auto">
                                        <img id="image-preview" class="h-10 w-10 object-cover rounded" src="#" alt="Vista previa">
                                    </div>
                                </label>
                                {% if form_errors.entry_image %}
                                <p class="text-red-500 text-xs italic mt-1">{{ form_errors.entry_image.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-3 space-y-3 sm:space-y-0">
                                <div class="flex flex-wrap gap-2">
                                    <!-- Switch para visibilidad -->
                                    <div class="flex items-center">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <span class="me-2 text-sm">
                                                <i class="fas fa-eye-slash text-gray-500"></i>
                                            </span>
                                            <input type="checkbox" name="visibility_switch" id="visibility_switch" class="sr-only peer" onchange="updateVisibilityValue()" {% if form.visibility.value == 'public' %}checked{% endif %}>
                                            <input type="hidden" name="visibility" id="visibility_input" value="{% if form.visibility.value %}{{ form.visibility.value }}{% else %}private{% endif %}">
                                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-eureka-orange rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-eureka-orange">
                                            </div>
                                            <span class="ms-2 text-sm">
                                                <i class="fas fa-globe text-gray-500"></i>
                                            </span>
                                        </label>
                                    </div>
                                    
                                    <!-- Botones para estado -->
                                    <div class="flex flex-wrap gap-1">
                                        <input type="hidden" name="status" id="status_input" value="{% if form.status.value %}{{ form.status.value }}{% else %}saved{% endif %}">
                                        <button type="button" id="btn_draft" onclick="setStatus('draft')" class="px-2 py-1 rounded-md {% if form.status.value == 'draft' %}bg-blue-100 text-blue-700 border-blue-200 status-active{% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %} flex items-center text-sm">
                                            <i class="fas fa-file-alt mr-1"></i> Borrador
                                        </button>
                                        <button type="button" id="btn_saved" onclick="setStatus('saved')" class="px-2 py-1 rounded-md {% if not form.status.value or form.status.value == 'saved' %}bg-green-100 text-green-700 border-green-200 status-active{% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %} flex items-center text-sm">
                                            <i class="fas fa-save mr-1"></i> Guardado
                                        </button>
                                        <button type="button" id="btn_favorite" onclick="setStatus('favorite')" class="px-2 py-1 rounded-md {% if form.status.value == 'favorite' %}bg-yellow-100 text-yellow-700 border-yellow-200 status-active{% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %} flex items-center text-sm">
                                            <i class="fas fa-star mr-1"></i> Favorito
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Selección de colección -->
                                <div class="flex flex-wrap items-center gap-2">
                                    <select name="collection" id="collection" class="p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-eureka-orange focus:border-transparent max-w-full" required>
                                        <option value="">Seleccionar colección</option>
                                        {% for collection in user_collections %}
                                            <option value="{{ collection.id }}" {% if form.collection.value == collection.id|stringformat:"s" %}selected{% endif %}>{{ collection.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn-primary transform transition hover:scale-105 whitespace-nowrap">
                                        <i class="fas fa-feather-alt mr-2"></i> Publicar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Entradas -->
            <div class="space-y-6">
                {% if entries %}
                    {% for entry in entries %}
                        <div class="card shadow-md border border-gray-100 overflow-hidden transform transition-all duration-300 hover:shadow-lg">
                            <div class="p-6">
                                <div class="flex items-center mb-4">
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                                        {% if entry.user.profile.profile_thumbnail %}
                                            <img src="{{ entry.user.profile.profile_thumbnail.url }}?t={{ entry.user.profile.updated_at|date:'U' }}" alt="{{ entry.user.username }}" class="w-full h-full object-cover">
                                        {% else %}
                                            <div class="w-full h-full bg-eureka-orange flex items-center justify-center text-eureka-dark font-bold">
                                                {{ entry.user.username.0|upper }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-eureka-dark">{{ entry.user.username }}</h3>
                                        <p class="text-gray-500 text-xs">{{ entry.created_at|date:"d/m/Y H:i" }}</p>
                                    </div>
                                    <div class="ml-auto">
                                        <div class="relative dropdown-menu">
                                            <button class="text-gray-400 hover:text-eureka-orange transition-colors p-2 rounded-full hover:bg-gray-100 dropdown-toggle">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="absolute right-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg overflow-visible z-[100] hidden dropdown-content border border-gray-200">
                                                <div class="py-1">
                                                    <a href="{% url 'entry_detail' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                        <i class="fas fa-eye mr-2 text-blue-500"></i> Ver detalle
                                                    </a>
                                                    <a href="{% url 'entry_edit' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                        <i class="fas fa-edit mr-2 text-green-500"></i> Editar
                                                    </a>
                                                    <a href="{% url 'entry_toggle_visibility' entry.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                        {% if entry.visibility == 'public' %}
                                                            <i class="fas fa-eye-slash mr-2 text-blue-500"></i> Hacer privada
                                                        {% else %}
                                                            <i class="fas fa-eye mr-2 text-green-500"></i> Hacer pública
                                                        {% endif %}
                                                    </a>
                                                    <div class="border-t border-gray-100 my-1"></div>
                                                    <a href="{% url 'entry_delete' entry.pk %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                                        <i class="fas fa-trash-alt mr-2"></i> Eliminar
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <a href="{% url 'entry_detail' entry.pk %}" class="block">
                                    <h4 class="text-xl font-bold text-eureka-dark mb-2 hover:text-eureka-orange transition-colors">{{ entry.title }}</h4>
                                    <p class="text-gray-700 mb-4">{{ entry.content|truncatewords:30 }}</p>
                                    
                                    {% if entry.entry_image %}
                                    <div class="relative h-48 mb-4 rounded-lg overflow-hidden">
                                        <a href="{{ entry.entry_image.url }}?t={{ entry.updated_at|date:'U' }}" 
                                           class="entry-image-link cursor-zoom-in block"
                                           data-pswp-width="{{ entry.entry_image.width }}" 
                                           data-pswp-height="{{ entry.entry_image.height }}"
                                           target="_blank">
                                            <img src="{{ entry.entry_image.url }}?t={{ entry.updated_at|date:'U' }}" 
                                                 alt="{{ entry.title }}" 
                                                 class="w-full h-full object-cover hover:opacity-95 transition-opacity">
                                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all flex items-center justify-center">
                                                <div class="text-white opacity-0 hover:opacity-100 transition-opacity">
                                                    <i class="fas fa-search-plus text-xl"></i>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                    {% endif %}
                                </a>
                                <div class="flex justify-between items-center">
                                    <div class="flex space-x-4">
                                        <a href="{% url 'entry_toggle_favorite' entry.pk %}" class="flex items-center text-gray-500 hover:text-eureka-orange transition-colors">
                                            {% if entry.status == 'favorite' %}
                                                <i class="fas fa-star text-yellow-500 mr-1"></i>
                                                <span>Favorito</span>
                                            {% else %}
                                                <i class="far fa-star mr-1"></i>
                                                <span>Marcar favorito</span>
                                            {% endif %}
                                        </a>
                                    </div>
                                    <a href="{% url 'entry_detail' entry.pk %}" class="text-eureka-orange hover:underline flex items-center">
                                        Leer más <i class="fas fa-chevron-right ml-1 text-xs"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                                <span class="text-sm text-gray-500 flex items-center">
                                    <i class="fas fa-folder text-eureka-orange mr-1"></i>
                                    {{ entry.collection.name }}
                                </span>
                                <span class="text-sm text-gray-500 flex items-center">
                                    <i class="fas fa-eye text-eureka-orange mr-1"></i>
                                    {{ entry.get_visibility_display }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- Paginación -->
                    {% if entries.paginator.num_pages > 1 %}
                    <div class="flex justify-center mt-8">
                        <nav class="inline-flex rounded-lg shadow-md overflow-hidden" aria-label="Paginación">
                            <!-- Botón anterior -->
                            {% if entries.has_previous %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ entries.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-white text-sm font-medium text-eureka-dark hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-chevron-left text-xs mr-1"></i>
                                    <span>Anterior</span>
                                </a>
                            {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                    <i class="fas fa-chevron-left text-xs mr-1"></i>
                                    <span>Anterior</span>
                                </span>
                            {% endif %}
                            
                            <!-- Números de página -->
                            <div class="hidden md:flex">
                                {% for i in entries.paginator.page_range %}
                                    {% if entries.number == i %}
                                        <span class="relative inline-flex items-center px-4 py-2 border-t border-b border-gray-200 bg-eureka-orange text-sm font-medium text-white">
                                            {{ i }}
                                        </span>
                                    {% elif i > entries.number|add:'-3' and i < entries.number|add:'3' %}
                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ i }}" class="relative inline-flex items-center px-4 py-2 border-t border-b border-gray-200 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                            {{ i }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Indicador de página en móvil -->
                            <div class="flex md:hidden items-center px-4 py-2 border-t border-b border-gray-200 bg-white text-sm font-medium text-gray-700">
                                <span>{{ entries.number }} de {{ entries.paginator.num_pages }}</span>
                            </div>
                            
                            <!-- Botón siguiente -->
                            {% if entries.has_next %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ entries.next_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-white text-sm font-medium text-eureka-dark hover:bg-gray-50 transition-colors">
                                    <span>Siguiente</span>
                                    <i class="fas fa-chevron-right text-xs ml-1"></i>
                                </a>
                            {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-200 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                    <span>Siguiente</span>
                                    <i class="fas fa-chevron-right text-xs ml-1"></i>
                                </span>
                            {% endif %}
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="card p-8 text-center">
                        <div class="text-6xl text-eureka-orange mb-4">
                            <i class="fas fa-feather-alt"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-eureka-dark mb-2">¡Comienza a escribir!</h3>
                        <p class="text-gray-600 mb-6">Aún no tienes entradas. Crea tu primera entrada para comenzar a compartir tus pensamientos.</p>
                        <button class="btn-primary">
                            <i class="fas fa-plus mr-2"></i> Crear entrada
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Contenedor de PhotoSwipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Cerrar (Esc)"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Anterior"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Siguiente"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar PhotoSwipe
        initPhotoSwipe();
        
        // Manejo de los menús desplegables
        const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        
        // Agregar evento de clic a cada botón
        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation(); // Evitar que el clic se propague
                
                // Obtener el contenido del menú desplegable asociado
                const dropdownContent = this.nextElementSibling;
                
                // Cerrar todos los demás menús desplegables
                document.querySelectorAll('.dropdown-content').forEach(content => {
                    if (content !== dropdownContent) {
                        content.classList.add('hidden');
                    }
                });
                
                // Alternar la visibilidad del menú actual
                dropdownContent.classList.toggle('hidden');
                
                if (!dropdownContent.classList.contains('hidden')) {
                    // Posicionar el menú - usar posición absoluta en lugar de fixed
                    dropdownContent.style.position = 'absolute';
                    dropdownContent.style.top = '100%';
                    dropdownContent.style.right = '0';
                    dropdownContent.style.zIndex = '100';
                    
                    // Asegurarse de que el menú sea visible
                    setTimeout(() => {
                        // Verificar si el menú se sale de la pantalla por abajo
                        const menuRect = dropdownContent.getBoundingClientRect();
                        if (menuRect.bottom > window.innerHeight) {
                            // Si se sale por abajo, colocarlo arriba del botón
                            dropdownContent.style.top = 'auto';
                            dropdownContent.style.bottom = '100%';
                        }
                    }, 0);
                }
            });
        });
        
        // Cerrar todos los menús desplegables al hacer clic en cualquier parte del documento
        document.addEventListener('click', function() {
            document.querySelectorAll('.dropdown-content').forEach(content => {
                content.classList.add('hidden');
            });
        });
        
        // Evitar que los clics dentro del menú desplegable lo cierren
        document.querySelectorAll('.dropdown-content').forEach(content => {
            content.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
        
        // Manejo de los filtros
        const toggleFiltersBtn = document.getElementById('toggle-filters');
        const toggleFiltersText = document.getElementById('toggle-filters-text');
        const filtersContainer = document.getElementById('filters-container');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const filterForm = document.getElementById('filter-form');
        
        // Mostrar/ocultar filtros
        if (toggleFiltersBtn && filtersContainer) {
            toggleFiltersBtn.addEventListener('click', function() {
                const isHidden = filtersContainer.classList.contains('hidden');
                filtersContainer.classList.toggle('hidden');
                
                // Cambiar el texto del botón
                if (isHidden) {
                    toggleFiltersText.textContent = 'Ocultar filtros';
                    toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-down');
                    toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-up');
                } else {
                    toggleFiltersText.textContent = 'Mostrar filtros';
                    toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-up');
                    toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-down');
                }
                
                // Animación suave
                if (isHidden) {
                    filtersContainer.style.maxHeight = '0';
                    filtersContainer.style.opacity = '0';
                    setTimeout(() => {
                        filtersContainer.style.transition = 'max-height 0.3s ease-in-out, opacity 0.3s ease-in-out';
                        filtersContainer.style.maxHeight = '1000px';
                        filtersContainer.style.opacity = '1';
                    }, 10);
                }
            });
        }
        
        // Restablecer filtros
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                // Restablecer selects
                document.getElementById('date_range').value = '7';
                
                // Restablecer select múltiple de colecciones
                const collectionsSelect = document.getElementById('collections');
                if (collectionsSelect) {
                    for (let i = 0; i < collectionsSelect.options.length; i++) {
                        collectionsSelect.options[i].selected = (i === 0); // Seleccionar solo "Todas las colecciones"
                    }
                }
                
                // Restablecer switches
                document.getElementById('only_favorites').checked = false;
                document.getElementById('include_drafts').checked = false;
                
                // Enviar el formulario
                filterForm.submit();
            });
        }
        
        // Mostrar los filtros si hay alguno aplicado
        const hasActiveFilters = 
            document.getElementById('only_favorites') && document.getElementById('only_favorites').checked || 
            document.getElementById('include_drafts') && document.getElementById('include_drafts').checked || 
            document.getElementById('date_range') && document.getElementById('date_range').value !== '7' ||
            (document.getElementById('collections') && Array.from(document.getElementById('collections').selectedOptions).some(option => option.value !== 'all'));
            
        if (hasActiveFilters && filtersContainer) {
            filtersContainer.classList.remove('hidden');
            if (toggleFiltersBtn) {
                toggleFiltersText.textContent = 'Ocultar filtros';
                toggleFiltersBtn.querySelector('i').classList.remove('fa-chevron-down');
                toggleFiltersBtn.querySelector('i').classList.add('fa-chevron-up');
            }
        }
    });
    
    // Función para actualizar el valor de visibilidad basado en el switch
    function updateVisibilityValue() {
        const switchElement = document.getElementById('visibility_switch');
        const inputElement = document.getElementById('visibility_input');
        
        if (switchElement.checked) {
            inputElement.value = 'public';
        } else {
            inputElement.value = 'private';
        }
    }
    
    // Función para establecer el estado
    function setStatus(status) {
        document.getElementById('status_input').value = status;
        
        // Resetear todos los botones
        document.getElementById('btn_draft').classList.remove('status-active', 'bg-blue-100', 'text-blue-700', 'border-blue-200');
        document.getElementById('btn_draft').classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
        
        document.getElementById('btn_saved').classList.remove('status-active', 'bg-green-100', 'text-green-700', 'border-green-200');
        document.getElementById('btn_saved').classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
        
        document.getElementById('btn_favorite').classList.remove('status-active', 'bg-yellow-100', 'text-yellow-700', 'border-yellow-200');
        document.getElementById('btn_favorite').classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
        
        // Activar el botón seleccionado
        if (status === 'draft') {
            document.getElementById('btn_draft').classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
            document.getElementById('btn_draft').classList.add('status-active', 'bg-blue-100', 'text-blue-700', 'border-blue-200');
        } else if (status === 'saved') {
            document.getElementById('btn_saved').classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
            document.getElementById('btn_saved').classList.add('status-active', 'bg-green-100', 'text-green-700', 'border-green-200');
        } else if (status === 'favorite') {
            document.getElementById('btn_favorite').classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200');
            document.getElementById('btn_favorite').classList.add('status-active', 'bg-yellow-100', 'text-yellow-700', 'border-yellow-200');
        }
    }
    
    // Función para previsualizar la imagen seleccionada
    function previewImage(input) {
        const previewContainer = document.getElementById('image-preview-container');
        const preview = document.getElementById('image-preview');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                previewContainer.classList.remove('hidden');
            }
            
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.src = '';
            previewContainer.classList.add('hidden');
        }
    }
    
    // Función para eliminar la imagen seleccionada
    function removeImage() {
        const input = document.getElementById('entry_image');
        const preview = document.getElementById('image-preview');
        const previewContainer = document.getElementById('image-preview-container');
        
        input.value = '';
        preview.src = '';
        previewContainer.classList.add('hidden');
    }
    
    // Inicializar PhotoSwipe
    function initPhotoSwipe() {
        const entryImageLinks = document.querySelectorAll('.entry-image-link');
        
        if (entryImageLinks.length > 0) {
            const lightbox = new PhotoSwipeLightbox({
                gallery: '.card',
                children: 'a.entry-image-link',
                pswpModule: PhotoSwipe,
                showHideAnimationType: 'zoom',
                initialZoomLevel: 'fit',
                secondaryZoomLevel: 2,
                maxZoomLevel: 4,
                wheelToZoom: true,
                padding: { top: 30, bottom: 30, left: 30, right: 30 },
                bgOpacity: 0.85,
                mainClass: 'pswp--custom-bg',
                closeTitle: 'Cerrar (Esc)',
                zoomTitle: 'Zoom in/out',
                arrowPrevTitle: 'Anterior',
                arrowNextTitle: 'Siguiente',
                errorMsg: 'La imagen no se pudo cargar'
            });
            
            lightbox.on('uiRegister', function() {
                lightbox.pswp.ui.registerElement({
                    name: 'custom-caption',
                    order: 9,
                    isButton: false,
                    appendTo: 'root',
                    html: 'Caption text',
                    onInit: (el, pswp) => {
                        lightbox.pswp.on('change', () => {
                            const currSlideElement = lightbox.pswp.currSlide.data.element;
                            let captionHTML = '';
                            if (currSlideElement) {
                                const alt = currSlideElement.querySelector('img').getAttribute('alt');
                                captionHTML = alt || '';
                            }
                            el.innerHTML = captionHTML;
                        });
                    }
                });
            });
            
            lightbox.init();
            
            // Prevenir comportamiento predeterminado de los enlaces
            entryImageLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                });
            });
        }
    }
</script>
{% endblock %} 